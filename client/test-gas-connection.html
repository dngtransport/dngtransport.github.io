<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNG Transport - Google Apps Script Connection Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                <i data-lucide="test-tube" class="w-6 h-6 mr-2 text-blue-600"></i>
                DNG Transport - Google Apps Script Test
            </h1>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-blue-900 mb-2">Testing URL:</h3>
                <p class="text-blue-800 font-mono text-sm break-all">
                    https://script.google.com/macros/s/AKfycbw8v2c1OFzepBk6Ue2hxqAuHULvLZLW6ok_7FE-gXnmCdA51mscFaNqRF1sAeYlSEhS/exec
                </p>
            </div>
            
            <div class="space-y-4">
                <button 
                    id="testConnectionBtn" 
                    class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center justify-center"
                >
                    <i data-lucide="send" class="w-5 h-5 mr-2"></i>
                    Test Booking Submission
                </button>
                
                <button 
                    id="testSimpleBtn" 
                    class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center"
                >
                    <i data-lucide="activity" class="w-5 h-5 mr-2"></i>
                    Test Simple Connection
                </button>
            </div>
            
            <div id="results" class="mt-6 hidden">
                <h2 class="text-lg font-semibold text-gray-900 mb-3">Test Results:</h2>
                <div id="resultContent" class="bg-gray-100 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap max-h-96 overflow-auto"></div>
            </div>
            
            <div id="loading" class="hidden mt-6 text-center">
                <div class="inline-flex items-center space-x-2 text-blue-600">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                    <span>Testing connection...</span>
                </div>
            </div>

            <div class="mt-6 bg-amber-50 border border-amber-200 rounded-lg p-4">
                <h3 class="font-semibold text-amber-800 mb-2">üìã Troubleshooting Steps:</h3>
                <ul class="text-amber-700 text-sm space-y-1">
                    <li>1. Make sure your Google Apps Script is deployed as a web app</li>
                    <li>2. Set "Execute as" to "Me" and "Who has access" to "Anyone"</li>
                    <li>3. Ensure the script has the doPost function implemented</li>
                    <li>4. Check if the Google Sheet ID is correctly set in the script</li>
                    <li>5. Make sure the script has permission to access Google Sheets</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw8v2c1OFzepBk6Ue2hxqAuHULvLZLW6ok_7FE-gXnmCdA51mscFaNqRF1sAeYlSEhS/exec';
        
        const testConnectionBtn = document.getElementById('testConnectionBtn');
        const testSimpleBtn = document.getElementById('testSimpleBtn');
        const results = document.getElementById('results');
        const resultContent = document.getElementById('resultContent');
        const loading = document.getElementById('loading');

        function showLoading(show) {
            loading.classList.toggle('hidden', !show);
            testConnectionBtn.disabled = show;
            testSimpleBtn.disabled = show;
        }

        function showResults(content) {
            results.classList.remove('hidden');
            resultContent.textContent = content;
        }

        // Test full booking submission
        testConnectionBtn.addEventListener('click', async () => {
            showLoading(true);
            
            const testBooking = {
                fullName: 'John Doe (Test)',
                phoneNumber: '0551234567',
                destination: 'Kumasi',
                travelDate: '2025-08-20',
                busType: 'sprinter',
                price: 117,
                currency: 'GHS',
                specialRequests: 'This is a test booking from the DNG Transport website connection test.',
                emergencyName: 'Jane Doe',
                emergencyPhone: '0557654321',
                timestamp: new Date().toISOString()
            };

            try {
                console.log('üì§ Sending test booking:', testBooking);
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testBooking)
                });

                const responseText = await response.text();
                console.log('üì• Raw response:', responseText);

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Invalid JSON response: ${responseText.substring(0, 200)}...`);
                }

                if (result.success) {
                    showResults(`‚úÖ SUCCESS!\n\nBooking Reference: ${result.bookingReference || 'Not provided'}\n\nFull Response:\n${JSON.stringify(result, null, 2)}`);
                } else {
                    showResults(`‚ùå BOOKING FAILED\n\nError: ${result.error}\n\nFull Response:\n${JSON.stringify(result, null, 2)}`);
                }

            } catch (error) {
                console.error('‚ùå Connection test failed:', error);
                showResults(`‚ùå CONNECTION TEST FAILED\n\nError: ${error.message}\n\nThis could mean:\n- Google Apps Script is not deployed correctly\n- CORS issues\n- Network connectivity problems\n- Script execution errors`);
            } finally {
                showLoading(false);
            }
        });

        // Test simple connection
        testSimpleBtn.addEventListener('click', async () => {
            showLoading(true);
            
            try {
                // Test with minimal data
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        test: true,
                        message: 'Simple connection test'
                    })
                });

                const responseText = await response.text();
                
                showResults(`üîç SIMPLE CONNECTION TEST\n\nStatus: ${response.status} ${response.statusText}\n\nHeaders: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}\n\nResponse Body:\n${responseText}`);

            } catch (error) {
                showResults(`‚ùå SIMPLE CONNECTION FAILED\n\nError: ${error.message}\n\nThis usually indicates:\n- CORS policy issues\n- Network problems\n- Google Apps Script not accessible`);
            } finally {
                showLoading(false);
            }
        });
    </script>
</body>
</html>
